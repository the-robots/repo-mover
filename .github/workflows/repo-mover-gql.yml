name: Migrate Repository - GQL

on:
  workflow_dispatch:
    inputs:
      source_org:
        description: 'Source organization'
        required: true
      target_org:
        description: 'Target organization'
        required: true
      repo_name:
        description: 'Repository name'
        required: true

jobs:
  migrate:
    runs-on: ubuntu-latest

    steps:
      - name: Check out Repository
        uses: actions/checkout@v3

      - name: Install GPG and Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y gnupg jq

      - name: Decrypt Private Key
        env:
          GPG_PASSPHRASE: ${{ secrets.GPG_PASSPHRASE }}
        run: |
          gpg --batch --yes --passphrase "$GPG_PASSPHRASE" \
            -o private-key.pem \
            -d .github/keys/repo-sidewinder.2024-10-29.private-key.pem.gpg

      - name: Install Octokit Dependencies
        run: npm install @octokit/app@12.0.3 @octokit/auth-app@3.0.0

      - name: Set GH_TOKEN Environment Variable
        run: |
          echo "Setting GH_TOKEN..."
          echo "GH_TOKEN=${{ secrets.PAT_TOKEN }}" >> $GITHUB_ENV

      - name: Fetch Organization ID
        id: org_id
        env:
          GH_TOKEN: ${{ secrets.PAT_TOKEN }}
        run: |
          echo "Fetching the global ID of the target organization..."
          ORG_DATA=$(curl -X POST -H "Authorization: Bearer $GH_TOKEN" -H "Content-Type: application/json" \
          -d '{"query": "query { organization(login: \"'${{ inputs.target_org }}'\") { id next_global_id } }"}' https://api.github.com/graphql)
          # Extract both the deprecated id and the next_global_id if available
          ORG_ID=$(echo "$ORG_DATA" | jq -r '.data.organization.next_global_id // .data.organization.id')
          echo "Using ORG_ID: $ORG_ID"
          echo "ORG_ID=$ORG_ID" >> $GITHUB_ENV

      - name: Initiate Migration with GraphQL
        env:
          GH_TOKEN: ${{ secrets.PAT_TOKEN }}
          ORG_ID: ${{ env.ORG_ID }}
        run: |
          echo "Initiating migration with GraphQL using ORG_ID=$ORG_ID..."
          curl -X POST -H "Authorization: Bearer $GH_TOKEN" -H "Content-Type: application/json" \
          -d "{
            \"query\": \"mutation { createMigrationSource(input: { name: \\\"${{ inputs.repo_name }}\\\", url: \\\"https://github.com/${{ inputs.source_org }}/${{ inputs.repo_name }}\\\", ownerId: \\\"$ORG_ID\\\", type: GITHUB_ARCHIVE }) { migrationSource { id } } }\"
          }" https://api.github.com/graphql

      - name: Monitor Migration Status (optional)
        env:
          GH_TOKEN: ${{ secrets.PAT_TOKEN }}
        run: |
          # Placeholder for monitoring migration completion
          echo "Checking migration status..."
          # Add code to query the migration status using GraphQL if needed

      - name: Cleanup
        run: rm -f private-key.pem
